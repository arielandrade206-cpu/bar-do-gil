<!DOCTYPE html>
<html>
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<link rel="icon" href="icon.png">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bar do Gil - Sistema PRO</title>

<style>
body{font-family:Arial;background:#0f172a;color:white;margin:0;padding:10px;}
h1,h3{text-align:center;color:#38bdf8;}
input,button{padding:8px;margin:5px 0;border-radius:8px;border:none;font-size:16px;}
button{background:#2563eb;color:white;cursor:pointer;}
.mesa,.historicoMesa{background:#1e293b;padding:10px;margin:5px 0;border-radius:10px;}
.mesa.selecionada{border:2px solid #22c55e;}
.total{color:#22c55e;font-weight:bold;}
.categoria{background:#334155;margin:5px 0;border-radius:6px;}
.categoria h4{margin:0;padding:10px;cursor:pointer;background:#1e293b;border-radius:6px;}
.produto{padding:5px 10px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #1e293b;}
.produto:last-child{border-bottom:none;}
.botoes{display:flex;gap:5px;}
.mais{background:#16a34a;}
.menos{background:#dc2626;}
.toast{
  position:fixed;
  top:20px;
  right:20px;
  background:#22c55e;
  color:white;
  padding:12px 18px;
  border-radius:10px;
  font-weight:bold;
  opacity:0;
  transform:translateY(-20px);
  transition:all .3s ease;
  z-index:9999;
}
.toast.show{
  opacity:1;
  transform:translateY(0);
}
</style>
</head>
<body>

<h1>üçª Bar do Gil</h1>

<h3>Criar Mesa</h3>
<input id="nomeMesa" placeholder="Digite o nome da mesa">
<button onclick="criarMesa()">Criar</button>

<h3>Pesquisar Produto</h3>
<input id="pesquisa" placeholder="Pesquisar..." onkeyup="filtrarProdutos()">

<div id="produtos"></div>

<h3>Mesas Abertas</h3>
<div id="mesas"></div>

<h3>Hist√≥rico de Contas Fechadas</h3>
<div id="historico"></div>

<h3>Resumo do Dia</h3>
<div id="resumoDia"></div>

<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, push, onValue, remove, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "SUA_API_KEY",
  authDomain: "SEU_AUTH_DOMAIN",
  databaseURL: "SUA_DATABASE_URL",
  projectId: "SEU_PROJECT_ID",
  storageBucket: "SEU_STORAGE",
  messagingSenderId: "SEU_ID",
  appId: "SEU_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const hoje = new Date().toISOString().split('T')[0];
const mesasRef = ref(db, "mesas/"+hoje);
const historicoRef = ref(db, "historico/"+hoje);

let mesaSelecionada = null;

window.mostrarToast = function(mensagem){
  const toast = document.getElementById("toast");
  toast.textContent = mensagem;
  toast.classList.add("show");
  setTimeout(()=> toast.classList.remove("show"),1500);
};

// ================= PRODUTOS =================
function mostrarProdutosPorCategoria(){
  const div = document.getElementById("produtos");
  div.innerHTML = "";

  Object.keys(categorias).forEach(cat => {
    const catDiv = document.createElement("div");
    catDiv.className = "categoria";

    const header = document.createElement("h4");
    header.textContent = cat;
    header.onclick = () => {
      const collapse = catDiv.querySelector(".collapse");
      collapse.style.display = collapse.style.display === "none" ? "block" : "none";
    };

    catDiv.appendChild(header);

    const listDiv = document.createElement("div");
    listDiv.className = "collapse";
    listDiv.style.display = "none";

    categorias[cat].forEach(prod => {
      const prodDiv = document.createElement("div");
      prodDiv.className = "produto";

      prodDiv.innerHTML = `
        <span>${prod.nome} - R$${prod.preco}</span>
        <div>
          <button class="menos">-</button>
          <button class="mais">+</button>
        </div>
      `;

      const itemRef = () => ref(db, "mesas/"+hoje+"/"+mesaSelecionada+"/itens/"+prod.nome);

      // ADICIONAR
      prodDiv.querySelector(".mais").onclick = () => {
        if(!mesaSelecionada){
          alert("Selecione uma mesa primeiro!");
          return;
        }

        onValue(itemRef(), snapshot => {
          let qtd = snapshot.exists()? snapshot.val().quantidade : 0;
          set(itemRef(), {
            nome: prod.nome,
            preco: prod.preco,
            quantidade: qtd + 1
          });
        }, {onlyOnce:true});

        mostrarToast(prod.nome + " +1");
      };

      // REMOVER
      prodDiv.querySelector(".menos").onclick = () => {
        if(!mesaSelecionada){
          alert("Selecione uma mesa primeiro!");
          return;
        }

        onValue(itemRef(), snapshot => {
          if(!snapshot.exists()) return;

          let dados = snapshot.val();
          let novaQtd = dados.quantidade - 1;

          if(novaQtd <= 0){
            remove(itemRef());
            mostrarToast(prod.nome + " removido");
          } else {
            set(itemRef(), {
              nome: prod.nome,
              preco: prod.preco,
              quantidade: novaQtd
            });
            mostrarToast(prod.nome + " -1");
          }
        }, {onlyOnce:true});
      };

      listDiv.appendChild(prodDiv);
    });

    catDiv.appendChild(listDiv);
    div.appendChild(catDiv);
  });
}

mostrarProdutosPorCategoria();

// ================= CRIAR MESA =================
window.criarMesa = function(){
  const nome = document.getElementById("nomeMesa").value;
  if(!nome) return alert("Digite o nome da mesa!");
  push(mesasRef, {nome, itens:{}});
  document.getElementById("nomeMesa").value = "";
};

// ================= ATUALIZAR MESAS =================
onValue(mesasRef, snapshot => {
  const data = snapshot.val();
  const div = document.getElementById("mesas");
  div.innerHTML = "";

  if(data){
    Object.keys(data).forEach(id => {
      const itens = data[id].itens || {};
      let total = 0;
      let detalhes = "";

      Object.values(itens).forEach(item => {
        total += item.preco * item.quantidade;
        detalhes += `${item.nome} x${item.quantidade} | `;
      });

      const mesaDiv = document.createElement("div");
      mesaDiv.className = "mesa";
      mesaDiv.innerHTML = `
        <strong>${data[id].nome}</strong><br>
        ${detalhes}<br>
        Total: <span class="total">R$${total}</span><br>
        <button class="fecharConta">Fechar Conta</button>
      `;

      mesaDiv.onclick = (e) => {
        if(e.target.classList.contains("fecharConta")) return;
        mesaSelecionada = id;
        document.querySelectorAll(".mesa").forEach(m => m.classList.remove("selecionada"));
        mesaDiv.classList.add("selecionada");
      };

      mesaDiv.querySelector(".fecharConta").onclick = (e) => {
        e.stopPropagation();

        push(historicoRef, {
          nome: data[id].nome,
          itens: data[id].itens,
          total: total,
          fechadoEm: new Date().toLocaleString()
        });

        remove(ref(db, "mesas/"+hoje+"/"+id));

        if(mesaSelecionada === id) mesaSelecionada = null;
      };

      div.appendChild(mesaDiv);
    });
  }
});

// ================= FILTRO =================
window.filtrarProdutos = function(){
  const filtro = document.getElementById("pesquisa").value.toLowerCase();
  document.querySelectorAll(".produto").forEach(prod => {
    prod.style.display = prod.textContent.toLowerCase().includes(filtro) ? "flex" : "none";
  });
};
</script>