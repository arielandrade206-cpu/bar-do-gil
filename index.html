<!DOCTYPE html>
<html>
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<link rel="icon" href="icon.png">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Bar do Gil</title>

<style>
body{
  margin:0;
  font-family:Arial;
  background:#0f172a;
  color:white;
  font: size 23px;   /* ğŸ”¥ aumenta aqui */
}

header{
  background:#1e3a8a;
  padding:15px;
  text-align:center;
  font-size:22px;
  font-weight:bold;
}

input,button{
  font-size:18px;
  padding:10px;
  border-radius:8px;
  border:none;
}

button{
  background:#2563eb;
  color:white;
  font-weight:bold;
}

.mesas{
  display:flex;
  overflow-x:auto;
  gap:8px;
  padding:10px;
}

.mesaBtn{
  background:#1e293b;
  padding:10px;
  border-radius:8px;
  white-space:nowrap;
}

.mesaAtiva{
  background:#2563eb;
  border:3px solid #22c55e;
  box-shadow:0 0 10px #22c55e;
}

#areaMesa{
  background:#111827;
  padding:10px;
}

.produtos{
  padding:10px;
}

.produto{
  background:#1e293b;
  padding:12px;
  border-radius:10px;
  margin-bottom:10px;
}

.tabs{
  display:flex;
  overflow-x:auto;
  gap:8px;
  padding:10px;
  background:#0f172a;
}

.tab{
  background:#1e293b;
  padding:8px 12px;
  border-radius:20px;
  white-space:nowrap;
}

.tabAtiva{
  background:#2563eb;
}

.toast{
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:#2563eb;
  padding:10px 20px;
  border-radius:20px;
  display:none;
}

#itensMesa .produto{
  font-size:24px;
}

</style>
</head>

<body>

<header>ğŸ» Bar do Gil</header>


<div style="padding:10px;">
<input id="novaMesa" placeholder="Nome da mesa">
<button onclick="criarMesa()">Criar</button>
<button onclick="relatorio()">ğŸ“Š RelatÃ³rio</button>
</div>


<div class="mesas" id="listaMesas"></div>

<div id="areaMesa">
<h3 id="mesaNome">Nenhuma mesa selecionada</h3>
<div id="itensMesa"></div>
<h2>Total: R$ <span id="total">0.00</span></h2>
<hr style="margin:15px 0;">

<h3>ğŸ’³ Pagamento</h3>

<select id="formaPagamento" onchange="verificarPagamento()">
  <option value="dinheiro">Dinheiro</option>
  <option value="pix">Pix</option>
</select>

<div id="areaDinheiro" style="margin-top:10px;">
  <input type="number" id="valorRecebido" placeholder="Valor recebido"
         oninput="calcularTroco()">
</div>

<h3 id="trocoArea" style="margin-top:10px;">
 <div id="areaPix" style="margin-top:15px; display:none; text-align:center;">
  <img id="qrCodePix" width="220">
  <p id="valorPix" style="margin-top:10px;"></p>
</div>
  Troco: R$ 0.00

</h3>
<button onclick="fecharConta()">ğŸ’° Fechar Conta</button>
</div>


<div style="padding:10px;">
<input id="pesquisa" placeholder="Pesquisar..." oninput="renderProdutos()">
</div>

<div class="tabs" id="tabs"></div>

<div class="produtos" id="produtos"></div>

<div class="toast" id="toast"></div>

<div id="modalRelatorio" style="
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.8);
  display:none;
  justify-content:center;
  align-items:center;
  padding:20px;
  z-index:999;
">

  <div style="
    background:#111827;
    width:100%;
    max-width:600px;
    max-height:90vh;
    overflow:auto;
    border-radius:15px;
    padding:20px;
  ">

    <h2 style="text-align:center;">ğŸ“Š RelatÃ³rio do Dia</h2>

    <div id="conteudoRelatorio"></div>

    <button style="margin-top:20px; width:100%;" 
            onclick="fecharRelatorio()">Fechar</button>

  </div>
</div>

<script type="module">

function gerarPayloadPix(chave, valor, nome="BAR DO GIL", cidade="BRASIL"){

  function format(id, value){
    const size = value.length.toString().padStart(2,"0");
    return id + size + value;
  }

  const payload =
    format("00","01") +
    format("26",
      format("00","BR.GOV.BCB.PIX") +
      format("01",chave)
    ) +
    format("52","0000") +
    format("53","986") +
    format("54",valor.toFixed(2)) +
    format("58","BR") +
    format("59",nome) +
    format("60",cidade) +
    format("62",
      format("05","***")
    );

  function crc16(str){
    let crc = 0xFFFF;
    for(let i=0;i<str.length;i++){
      crc ^= str.charCodeAt(i) << 8;
      for(let j=0;j<8;j++){
        if(crc & 0x8000){
          crc = (crc << 1) ^ 0x1021;
        } else {
          crc = crc << 1;
        }
      }
    }
    return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4,"0");
  }

  const payloadFinal = payload + "6304";
  const crc = crc16(payloadFinal);

  return payloadFinal + crc;
}

import { get } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getDatabase, ref, set, push, onValue, update, remove } 
from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBqezLaspgcS9B42CXOZl-FyY-SI5TphIk",
  authDomain: "commanda-71512.firebaseapp.com",
  databaseURL: "https://commanda-71512-default-rtdb.firebaseio.com",
  projectId: "commanda-71512",
  storageBucket: "commanda-71512.firebasestorage.app",
  messagingSenderId: "789071833045",
  appId: "1:789071833045:web:d28a7b2dddaa448304ff5c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const chavePix = "+5577981208309"; // ğŸ”¥ SUA CHAVE PIX

let mesaAtual = null;
let abaAtual = "Espetos";

const hoje=new Date().toISOString().split("T")[0];

const produtos = {

"Espetos":[
["Calabresa apimentada",6],
["Calabresa defumada",6],
["CoraÃ§Ã£o",6],
["Frango com bacon",6],
["Frango com osso",6],
["Gado",6],
["PÃ£o de alho",6],
["Porco",6],
["Queijo com bacon",6]
],

"Refris 1L / 2L":[
["Coca 1L",9],
["Coca 2L",14],
["Coca Ls",8],
["GuaranÃ¡ 1L",8],
["GuaranÃ¡ 2L",13],
["Pepsi 1L",8],
["Pepsi 2L",10],
["Pepsi 2L zero",10],
["Pepsi zero 1L",8],
["Pepsi twister",10],
["Sukita laranja 1L",8],
["Sukita laranja 2L",11],
["Sukita uva 2L",11]
],

"Refris Lata":[
["Coca lata",5],
["GuaranÃ¡ Lata",5],
["GuaranÃ¡ zero",4],
["Pepsi zero lata",4],
["Soda limonada",4],
["Sukita laranja",4],
["Sukita uva",4],
["Fys em geral",5],
["It em geral",4],
["It! Coca",8],
["It! Laranja",8],
["It! limao",8],
["It! guarana",8]
],

"Cerveja lata":[
["Amstel",5],
["AntÃ¡rtica",5],
["Black princess",5],
["Brahma",5],
["Brahma zero",5],
["Caracu",7],
["Crystal",5],
["Crystal baden",5],
["Devassa",5],
["Lokal",4],
["Original",6],
["Skol",5],
["Subzero",5]
],

"Piriguetes":[
["Brahma piriguete",5],
["Crystal piriguete",5],
["Original piriguete",5],
["Petra piriguete",5],
["Skol piriguete",5]
],

"Long neck":[
["Budweiser",8],
["Budweiser zero",8],
["CabarÃ© frutas vermelhas",8],
["CabarÃ© limÃ£o",8],
["Heineken",9],
["Itaipava zero",8]
],

"Cervejas 600ML":[
["Amstel",9],
["Antarctica",9],
["Brahma",10],
["Budweiser",10],
["Crystal",6],
["Heineken",12],
["Itaipava",7],
["Itaipava Premium",9],
["Lokal",6],
["Original",10],
["Petra",8],
["Skol",10],
["Subzero",8]
],

"EnergÃ©tico":[
["Beats frutas verdes",7],
["Monster",14],
["Redbull",10],
["Tnt 269ML",8],
["Tnt 473ML",10]
],

"Outros":[
["Agua de coco",7],
["Ãgua com gÃ¡s",4],
["Ãgua mineral",3],
["H2o 1,5L",10],
["H2o 500ML",7],
["Skinka laranja",5],
["Skinka morango",5],
["Skinka uva",5]
],

"PorÃ§Ãµes":[
["FeijÃ£o farofado (1)",1],
["FeijÃ£o farofado (3)",3],
["FeijÃ£o farofado (5)",5],
["FeijÃ£o farofado (10)",10],
["Mandioca (1)",1],
["Mandioca (3)",3],
["Mandioca (5)",5],
["Mandioca (10)",10],
["Vinagrete",0]
]

};

function toast(msg){
const t=document.getElementById("toast");
t.innerText=msg;
t.style.display="block";
setTimeout(()=>t.style.display="none",2000);
}

window.criarMesa=function(){
const nome=document.getElementById("novaMesa").value.trim();
if(!nome) return;

set(ref(db,`mesas/${hoje}/${nome}`),{
criadaEm:Date.now(),
total:0,
itens:{}
});

document.getElementById("novaMesa").value="";
toast("Mesa criada");
};

function carregarMesas(){
onValue(ref(db,`mesas/${hoje}`),(snap)=>{
const area=document.getElementById("listaMesas");
area.innerHTML="";
if(!snap.exists()) return;

const dados=Object.entries(snap.val())
.sort((a,b)=>b[1].criadaEm-a[1].criadaEm);

dados.forEach(([nome])=>{
const btn=document.createElement("div");
btn.className="mesaBtn";
btn.innerText=nome;
btn.onclick=()=>selecionarMesa(nome);
area.appendChild(btn);
});
});
}

function selecionarMesa(nome){

  mesaAtual = nome;

  document.getElementById("mesaNome").innerText = nome;

  // ğŸ”¥ Remove seleÃ§Ã£o anterior
  document.querySelectorAll(".mesaBtn").forEach(btn=>{
    btn.classList.remove("mesaAtiva");
  });

  // ğŸ”¥ Adiciona contorno na mesa clicada
  const botoes = document.querySelectorAll(".mesaBtn");
  botoes.forEach(btn=>{
    if(btn.innerText === nome){
      btn.classList.add("mesaAtiva");
    }
  });

  onValue(ref(db, `mesas/${hoje}/${nome}`),(snap)=>{
    const dados = snap.val();

    document.getElementById("total").innerText =
      (dados.total || 0).toFixed(2);

    const area = document.getElementById("itensMesa");
    area.innerHTML = "";

    if(dados.itens){
      Object.entries(dados.itens).forEach(([id,item])=>{
        const div = document.createElement("div");
        div.className="produto";
        div.innerHTML = `
  <b>${item.nome}</b><br>

  <button onclick="alterarQtd('${id}', -1, ${item.preco})">â–</button>
  <span style="margin:0 10px;">${item.qtd}</span>
  <button onclick="alterarQtd('${id}', 1, ${item.preco})">â•</button>

  <br>
  Total: R$ ${(item.qtd * item.preco).toFixed(2)}

  <br><br>
  <button onclick="removerItem('${id}', ${item.preco}, ${item.qtd})">
    âŒ Remover tudo
  </button>
`;
        area.appendChild(div);
      });
    }

  });
}

window.removerItem = async function(id, preco, qtd){

  const itemRef = ref(db, `mesas/${hoje}/${mesaAtual}/itens/${id}`);

  if(qtd > 1){

    // ğŸ”¥ diminui sÃ³ 1 unidade
    await update(itemRef, {
      qtd: qtd - 1
    });

  } else {

    // ğŸ”¥ sÃ³ remove quando chegar a 1
    await remove(itemRef);

  }

  // ğŸ”¥ Atualiza total corretamente
  const mesaRef = ref(db, `mesas/${hoje}/${mesaAtual}`);
  const snap = await get(mesaRef);

  let totalAtual = snap.val().total || 0;
  totalAtual -= preco;

  if(totalAtual < 0) totalAtual = 0;

  await update(mesaRef, { total: totalAtual });

  toast("1 item removido");
}

function renderTabs(){
  const area=document.getElementById("tabs");
  area.innerHTML="";
  Object.keys(produtos).forEach(cat=>{
    const btn=document.createElement("div");
    btn.className="tab"+(cat===abaAtual?" tabAtiva":"");
    btn.innerText=cat;
    btn.onclick=()=>{
      abaAtual=cat;
      renderTabs();
      renderProdutos();
    }
    area.appendChild(btn);
  });
}
function renderProdutos(){
const area=document.getElementById("produtos");
area.innerHTML="";
const filtro=document.getElementById("pesquisa").value.toLowerCase();

produtos[abaAtual]
.filter(p=>p[0].toLowerCase().includes(filtro))
.forEach((p,i)=>{
const div=document.createElement("div");
div.className="produto";
div.innerHTML=`
${p[0]} - R$ ${p[1]}
<br>
<input type="number" min="1" value="1" id="q${i}">
<button>Adicionar</button>
`;

div.querySelector("button").onclick = async () => {

  if (!mesaAtual) {
    alert("Selecione uma mesa");
    return;
  }

  const qtd = parseInt(document.getElementById("q"+i).value);

  const itensRef = ref(db, `mesas/${hoje}/${mesaAtual}/itens`);
  const snapshot = await get(itensRef);

  let encontrou = false;

  if (snapshot.exists()) {
    Object.entries(snapshot.val()).forEach(([id, item]) => {

      if (item.nome === p[0]) {

        update(ref(db, `mesas/${hoje}/${mesaAtual}/itens/${id}`), {
          qtd: item.qtd + qtd
        });

        encontrou = true;
      }

    });
  }

  if (!encontrou) {

    const itemRef = push(itensRef);

    set(itemRef, {
      nome: p[0],
      preco: p[1],
      qtd: qtd
    });

  }

  // Atualiza total corretamente
  const mesaSnap = await get(ref(db, `mesas/${hoje}/${mesaAtual}`));
  let totalAtual = mesaSnap.val().total || 0;

  await update(ref(db, `mesas/${hoje}/${mesaAtual}`), {
    total: totalAtual + (p[1] * qtd)
  });

  toast("Item adicionado!");

};

area.appendChild(div);
});
}

window.fecharConta = async function(){

  if(!mesaAtual) return alert("Selecione uma mesa");

  const mesaRef = ref(db, `mesas/${hoje}/${mesaAtual}`);
  const snap = await get(mesaRef);

  const dados = snap.val();

  await set(ref(db, `historico/${hoje}/${mesaAtual}`), dados);

  await remove(mesaRef);

  mesaAtual = null;

  document.getElementById("mesaNome").innerText = "Nenhuma mesa selecionada";
  document.getElementById("itensMesa").innerHTML = "";
  document.getElementById("total").innerText = "0.00";

  toast("Conta fechada!");
};

window.relatorio = async function(){

  const snap = await get(ref(db, `historico/${hoje}`));

  if(!snap.exists()){
    alert("Sem vendas hoje");
    return;
  }

  let totalDia = 0;
  let totalMesas = 0;
  let produtosContagem = {};
  let resumoMesas = "";

  Object.entries(snap.val()).forEach(([nomeMesa, mesa])=>{

    totalMesas++;
    totalDia += mesa.total || 0;

    resumoMesas += `
      <div style="background:#1e293b; padding:10px; border-radius:10px; margin-bottom:10px;">
        <b>ğŸª‘ Mesa ${nomeMesa}</b><br>
        ğŸ’° Total: R$ ${(mesa.total || 0).toFixed(2)}
      </div>
    `;

    if(mesa.itens){
      Object.values(mesa.itens).forEach(item=>{
        if(!produtosContagem[item.nome]){
          produtosContagem[item.nome] = 0;
        }
        produtosContagem[item.nome] += item.qtd;
      });
    }

  });

  let maisVendido = "Nenhum";
  let maiorQtd = 0;

  Object.entries(produtosContagem).forEach(([nome, qtd])=>{
    if(qtd > maiorQtd){
      maiorQtd = qtd;
      maisVendido = nome;
    }
  });

  let listaProdutos = "";

  Object.entries(produtosContagem)
    .sort((a,b)=>b[1]-a[1])
    .forEach(([nome, qtd])=>{
      listaProdutos += `
        <div style="display:flex; justify-content:space-between;">
          <span>${nome}</span>
          <span>${qtd}x</span>
        </div>
      `;
    });

  const ticketMedio = totalMesas > 0 ? totalDia / totalMesas : 0;

  document.getElementById("conteudoRelatorio").innerHTML = `
    <div style="margin-bottom:15px;">
      <b>ğŸ’° Total vendido:</b> R$ ${totalDia.toFixed(2)}<br>
      <b>ğŸª‘ Mesas fechadas:</b> ${totalMesas}<br>
      <b>ğŸ“ˆ Ticket mÃ©dio:</b> R$ ${ticketMedio.toFixed(2)}<br>
      <b>ğŸ† Mais vendido:</b> ${maisVendido} (${maiorQtd}x)
    </div>

    <hr style="margin:15px 0;">

    <h3>ğŸ“¦ Produtos Vendidos</h3>
    ${listaProdutos}

    <hr style="margin:15px 0;">

    <h3>ğŸ“‹ Resumo das Mesas</h3>
    ${resumoMesas}
  `;

  document.getElementById("modalRelatorio").style.display = "flex";
};

 
window.alterarQtd = async function(id, delta, preco){

  const itemRef = ref(db, `mesas/${hoje}/${mesaAtual}/itens/${id}`);
  const snap = await get(itemRef);

  if(!snap.exists()) return;

  let item = snap.val();
  let novaQtd = item.qtd + delta;

  // Se quantidade for 0, remove o item
  if(novaQtd <= 0){

    await remove(itemRef);

    const mesaSnap = await get(ref(db, `mesas/${hoje}/${mesaAtual}`));
    let totalAtual = mesaSnap.val().total || 0;

    totalAtual -= preco;
    if(totalAtual < 0) totalAtual = 0;

    await update(ref(db, `mesas/${hoje}/${mesaAtual}`), {
      total: totalAtual
    });

    return;
  }

  // Atualiza quantidade
  await update(itemRef, { qtd: novaQtd });

  // Atualiza total
  const mesaSnap = await get(ref(db, `mesas/${hoje}/${mesaAtual}`));
  let totalAtual = mesaSnap.val().total || 0;

  totalAtual += preco * delta;

  await update(ref(db, `mesas/${hoje}/${mesaAtual}`), {
    total: totalAtual
  });

};

window.verificarPagamento = async function(){

  console.log("verificarPagamento rodou");

  if(!mesaAtual) return;

  const forma = document.getElementById("formaPagamento").value;

  const mesaSnap = await get(ref(db, `mesas/${hoje}/${mesaAtual}`));
  const total = mesaSnap.val().total || 0;

  console.log("Total:", total);

  if(forma === "pix"){

    document.getElementById("areaDinheiro").style.display = "none";
    document.getElementById("areaPix").style.display = "block";

    const payload = gerarPayloadPix(chavePix, total);

    const urlQR =
      "https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=" +
      encodeURIComponent(payload);

    document.getElementById("qrCodePix").src = urlQR;
    document.getElementById("valorPix").innerText =
      "Valor: R$ " + total.toFixed(2);

  } else {

    document.getElementById("areaDinheiro").style.display = "block";
    document.getElementById("areaPix").style.display = "none";
    calcularTroco();

  }
};

window.calcularTroco = async function(){

  if(!mesaAtual) return;

  const recebido = parseFloat(
    document.getElementById("valorRecebido").value
  ) || 0;

  const mesaSnap = await get(ref(db, `mesas/${hoje}/${mesaAtual}`));
  const total = mesaSnap.val().total || 0;

  const troco = recebido - total;

  document.getElementById("trocoArea").innerText =
    "Troco: R$ " + (troco > 0 ? troco.toFixed(2) : "0.00");
}

window.fecharRelatorio = function(){
  document.getElementById("modalRelatorio").style.display = "none";
};

renderTabs();
renderProdutos();
carregarMesas();

</script>
</body>
</html>

